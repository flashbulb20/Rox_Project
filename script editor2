import omni.ui as ui
import omni.timeline
import omni.kit.app
import carb
from typing import Dict

# 1. ì •ë³´ íŒ¨ë„ í´ë˜ìŠ¤ ì •ì˜
class DetailedInfoPanel:
    def __init__(self):
        # UI ìƒíƒœë¥¼ ì €ì¥í•  ë”•ì…”ë„ˆë¦¬
        self.data: Dict[str, any] = {
            "is_playing": False,
            "current_time": 0.0,
            "last_detected_color": "None",
            "classification_id": "00",
            "total_count": 0,
            "red_count": 0,
            "blue_count": 0,
            "green_count": 0,
        }

        # Omniverse Kit/Carb ì„¤ì •ì„ í†µí•´ ì£¼ ëª¨ë‹ˆí„°ì˜ í•´ìƒë„ ì •ë³´ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
        settings = carb.settings.get_settings()
        screen_width = settings.get_as_int("/app/window/width")
        screen_height = settings.get_as_int("/app/window/height")
        
        # ìœˆë„ìš° ìƒì„±
        self.window = ui.Window(
            title="Info Window", 
            width=400, 
            height=250, 
            position_x= 10,                    # X ì¢Œí‘œ ì§€ì •
            position_y= screen_height - 250/2, # Y ì¢Œí‘œ ì§€ì •
            allow_docking=True)
        
        # UI ìœ„ì ¯ ì´ˆê¸°í™” ë° ë ˆì´ì•„ì›ƒ ì„¤ì •
        with self.window.frame:
            with ui.VStack(spacing=5, height=0):
                # ì‹œë®¬ë ˆì´ì…˜ ìƒíƒœ ë¼ë²¨
                self.status_label = ui.Label(
                    "ğŸ”´ Simulation Inactive", 
                    height=20, 
                    alignment=ui.Alignment.CENTER,
                    style={"font_size": 18, "color": 0xFF888888} # íšŒìƒ‰
                )
                ui.Separator()
                
                # ë°ì´í„° í‘œì‹œ ë¼ë²¨ (Gridë¥¼ Frameìœ¼ë¡œ ëŒ€ì²´í•˜ê³ , GridLayoutì„ ì‚¬ìš©)
                # ui.Grid(column_count=2, spacing=5) ëŒ€ì‹  ì•„ë˜ ì½”ë“œë¥¼ ì‚¬ìš©í•´ë³´ì„¸ìš”.

                with ui.Frame(height=0): # Frameì„ ì‚¬ìš©í•˜ì—¬ ì»¨í…Œì´ë„ˆ ì—­í• 
                    # Grid Layout ì„¤ì •
                    with ui.HStack(spacing=5): # ìˆ˜í‰ ìŠ¤íƒì„ ì‚¬ìš©í•˜ì—¬ ë¬¶ìŒ
                        # GridëŠ” LayoutFunctionìœ¼ë¡œ ëŒ€ì²´ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                        ui.Label("Time:", width=150, alignment=ui.Alignment.RIGHT) # ë„ˆë¹„ ì§€ì •í•˜ì—¬ ì—´ ë§ì¶¤
                        self.time_label = ui.Label("--", width=150, alignment=ui.Alignment.LEFT)

                    with ui.HStack(spacing=5):
                        # Detected Color
                        ui.Label("Color:", width=150, alignment=ui.Alignment.RIGHT)
                        self.color_label = ui.Label("--", width=150, alignment=ui.Alignment.LEFT)
                        
                    with ui.HStack(spacing=5):
                        # Classification ID
                        ui.Label("Class ID:", width=150, alignment=ui.Alignment.RIGHT)
                        self.id_label = ui.Label("--", width=150, alignment=ui.Alignment.LEFT)

                ui.Separator()

                # Count ì •ë³´ í‘œì‹œ ë¶€ë¶„ë„ HStackìœ¼ë¡œ ëŒ€ì²´
                with ui.Frame(height=0):
                    with ui.HStack(spacing=5):
                        ui.Label("Total Processed:", width=150, alignment=ui.Alignment.RIGHT)
                        self.total_count_label = ui.Label("0", width=150, alignment=ui.Alignment.LEFT)
                        
                    with ui.HStack(spacing=5):
                        # Individual Counts
                        ui.Label("R/G/B Count:", width=150, alignment=ui.Alignment.RIGHT)
                        self.rgb_count_label = ui.Label("R:0 / G:0 / B:0", width=150, alignment=ui.Alignment.LEFT)

        # íƒ€ì„ë¼ì¸ ë° ì—…ë°ì´íŠ¸ êµ¬ë… ì„¤ì •
        self.timeline = omni.timeline.get_timeline_interface()
        self.subscription = omni.kit.app.get_app().get_update_event_stream().create_subscription_to_pop(
            self.on_update, name="DetailedInfoPanel Update"
        )
        
        # ì´ˆê¸° UI ì—…ë°ì´íŠ¸ (ì‹œë®¬ë ˆì´ì…˜ ì „ ìƒíƒœ í‘œì‹œ)
        self.update_ui_elements()
        carb.log_info("Detailed Info Panel Initialized.")

    # 2. UI ìœ„ì ¯ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    def update_ui_elements(self):
        # ë°ì´í„°(self.data)ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ëª¨ë“  UI ìœ„ì ¯ì„ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
        
        # ìƒíƒœ ë¼ë²¨ ì—…ë°ì´íŠ¸
        is_playing = self.timeline.is_playing()
        
        if is_playing:
            # ì¬ìƒ ì¤‘
            self.status_label.text = "ğŸŸ¢ Simulation Running"
            self.status_label.set_style({"color": 0xFF58FA2A}) # ë…¹ìƒ‰
        else:
            # ì¼ì‹œ ì •ì§€ ë˜ëŠ” ì¤‘ì§€
            self.status_label.text = "ğŸ”´ Simulation Paused/Stopped"
            self.status_label.set_style({"color": 0xFFFA2A2A}) # ë¹¨ê°„ìƒ‰
            
            # ì‹œë®¬ë ˆì´ì…˜ ì •ì§€ ì‹œ ì‹œê°„ ë° ë°ì´í„° ì´ˆê¸°í™” ë˜ëŠ” ìœ ì§€ (ì—¬ê¸°ì„œëŠ” ìœ ì§€)
            if self.timeline.get_current_time() == 0.0:
                 self.time_label.text = "--"
                 
        # ë°ì´í„° ë¼ë²¨ ì—…ë°ì´íŠ¸ (ì¬ìƒ ì¤‘ì¼ ë•Œë§Œ ì‹¤ì‹œê°„ ë°ì´í„°ë¥¼ ë°˜ì˜)
        self.time_label.text = f"{self.data['current_time']:.2f} s"

        # ìƒ‰ìƒ ë¼ë²¨ ë° ID
        color = self.data['last_detected_color']
        class_id = self.data['classification_id']
        
        # ìƒ‰ìƒì— ë”°ë¼ í…ìŠ¤íŠ¸ ìƒ‰ìƒ ë³€ê²½ (ì˜ˆì‹œ)
        color_style = {"color": 0xFFFFFFFF}
        if color == "Red":
            color_style = {"color": 0xFFFF5555}
        elif color == "Green":
            color_style = {"color": 0xFF55FF55}
        elif color == "Blue":
            color_style = {"color": 0xFF5555FF}
            
        self.color_label.text = color
        self.color_label.set_style(color_style)
        self.id_label.text = class_id

        # ì¹´ìš´íŠ¸ ì •ë³´
        self.total_count_label.text = str(self.data['total_count'])
        self.rgb_count_label.text = (
            f"R:{self.data['red_count']} / G:{self.data['green_count']} / B:{self.data['blue_count']}"
        )


    # 3. ì‹œë®¬ë ˆì´ì…˜ í”„ë ˆì„ ì—…ë°ì´íŠ¸ ì½œë°± í•¨ìˆ˜
    def on_update(self, event):
        #ë§¤ ì‹œë®¬ë ˆì´ì…˜ í”„ë ˆì„ë§ˆë‹¤ í˜¸ì¶œë©ë‹ˆë‹¤.
        
        # ì‹œë®¬ë ˆì´ì…˜ì´ ì¬ìƒ ì¤‘ì¼ ë•Œë§Œ ë°ì´í„° ì—…ë°ì´íŠ¸ ë¡œì§ ì‹¤í–‰
        if self.timeline.is_playing():
            # (A) ì‹œë®¬ë ˆì´ì…˜ ì‹œê°„ ì—…ë°ì´íŠ¸
            self.data["current_time"] = self.timeline.get_current_time()
            
            # (B) ë”ë¯¸ ë°ì´í„° ì—…ë°ì´íŠ¸ (ì‹¤ì œ ë¡œë´‡/ì¹´ë©”ë¼ ë°ì´í„°ë¡œ ëŒ€ì²´í•´ì•¼ í•¨)
            self.simulate_detection_logic()
            
        # (C) UI ì—…ë°ì´íŠ¸ (ì¬ìƒ ì¤‘ì´ë“  ì•„ë‹ˆë“  ìƒíƒœ ë¼ë²¨ ë“±ì„ ì—…ë°ì´íŠ¸í•´ì•¼ í•¨)
        self.update_ui_elements()


    # 4. (ì˜ˆì‹œ) ë”ë¯¸ ê°ì§€ ë¡œì§ - ì‹¤ì œ ì‹œë®¬ë ˆì´ì…˜ ë°ì´í„°ë¡œ ëŒ€ì²´ í•„ìš”
    def simulate_detection_logic(self):
        # ì´ í•¨ìˆ˜ëŠ” ì‹¤ì œ ì„¼ì„œ ë°ì´í„° ì½ê¸°, ìƒ‰ìƒ ë¶„ì„, ê°ì²´ ë¶„ë¥˜ ì½”ë“œë¡œ ëŒ€ì²´ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.
        
        frame = int(self.data["current_time"] * 60) # ì´ˆë‹¹ 60í”„ë ˆì„ ê°€ì •
        
        if frame % 100 == 0: # 100í”„ë ˆì„ë§ˆë‹¤ ìƒˆ ê°ì²´ ê°ì§€ ì‹œë®¬ë ˆì´ì…˜
            self.data["total_count"] += 1
            current_count = self.data["total_count"]
            
            if current_count % 3 == 1:
                # ë¹¨ê°„ìƒ‰ ê°ì§€ ì‹œë®¬ë ˆì´ì…˜
                self.data["last_detected_color"] = "Red"
                self.data["classification_id"] = "R-101"
                self.data["red_count"] += 1
            elif current_count % 3 == 2:
                # ë…¹ìƒ‰ ê°ì§€ ì‹œë®¬ë ˆì´ì…˜
                self.data["last_detected_color"] = "Green"
                self.data["classification_id"] = "G-202"
                self.data["green_count"] += 1
            else:
                # íŒŒë€ìƒ‰ ê°ì§€ ì‹œë®¬ë ˆì´ì…˜
                self.data["last_detected_color"] = "Blue"
                self.data["classification_id"] = "B-303"
                self.data["blue_count"] += 1
        else:
             # ê°ì§€ë˜ì§€ ì•Šì„ ë•Œ (ì´ì „ ê°’ ìœ ì§€)
             pass


    # 5. ì°½ ì¢…ë£Œ ë° êµ¬ë… í•´ì§€
    def destroy(self):
        self.subscription = None # êµ¬ë… í•´ì§€
        self.window.destroy()
        carb.log_info("Detailed Info Panel Destroyed.")


# 6. ì¸ìŠ¤í„´ìŠ¤ ìƒì„± ë° ì‹¤í–‰ (ìŠ¤í¬ë¦½íŠ¸ ì—ë””í„° ì‹¤í–‰ ë¶€ë¶„)
# ê¸°ì¡´ì— live_panelì´ ìˆë‹¤ë©´ ì •ë¦¬
if 'live_panel' in globals() and isinstance(live_panel, DetailedInfoPanel):
    live_panel.destroy()
    
# ìƒˆ ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
live_panel = DetailedInfoPanel()
print("Custom Info Panel setup complete. Press Play in the simulator to see updates.")
